<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Request Details</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body style="overflow-y: hidden">

<div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar" th:replace="~{fragments/sidebar :: sidebar}"></aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Header -->
        <header class="header">
            <h1 th:text="'Details for Request #' + ${request.requestId}">Details</h1>

            <!-- Spacer to push user profile and notifications to the right -->
            <div style="margin-left: auto; display: flex; align-items: center;">
                <!-- NOTIFICATION BELL AREA - START -->
                <div class="notification-area">
                    <button id="notificationBell" class="notification-bell-button" aria-label="Notifications">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
                        <span id="notificationCountBadge" class="notification-badge" style="display:none;">0</span>
                    </button>
                    <div id="notificationDropdown" class="notification-dropdown">
                        <div class="notification-dropdown-header">
                            <span>Notifications</span>
                            <button id="markAllAsReadBtn" class="mark-all-read-btn">Mark all as read</button>
                        </div>
                        <ul id="notificationList" class="notification-list">
                            <!-- Notifications will be loaded here by JS -->
                            <li class="no-notifications" style="display:none; text-align:center; padding: 20px; color: #777;">No new notifications.</li>
                        </ul>
                        <div class="notification-dropdown-footer">
                            <a th:href="@{/notifications/all}">View all notifications</a>
                        </div>
                    </div>
                </div>
                <!-- NOTIFICATION BELL AREA - END -->

                <div class="user-profile">
                    <span sec:authentication="principal.username">user@example.com</span>
                    <form th:action="@{/logout}" method="post"><button type="submit" class="btn-logout">Logout</button></form>
                </div>
            </div>
        </header>

        <!-- Page Content -->
        <div class="page-content">
            <div class="form-container">
                <!-- General Info -->
                <div class="form-section">
                    <h3>General Information</h3>
                    <div class="form-grid">
                        <div><strong>Created By:</strong> <span th:text="${request.creatorFullName}"></span></div>
                        <div><strong>Department:</strong> <span th:text="${request.departmentName}"></span></div>
                        <div><strong>Created At:</strong> <span th:text="${#temporals.format(request.createdAt, 'dd-MMM-yyyy HH:mm')}"></span></div>
                        <div><strong>Budget Code:</strong> <span th:text="${request.budgetCode}"></span></div>
                        <div><strong>Status:</strong>
                            <span class="status-badge"
                                  th:classappend="${#strings.toLowerCase(request.status).replace(' ', '-')} == 'pending' ? 'status-pending' : (${#strings.toLowerCase(request.status).replace(' ', '-')} == 'approved' ? 'status-approved' : (${#strings.toLowerCase(request.status).replace(' ', '-')} == 'rejected' ? 'status-rejected' : 'status-returned-for-edit'))"
                                  th:text="${request.status}">
                            </span>
                        </div>
                        <div th:if="${request.rejectReason}"><strong>Reason:</strong> <span style="color: #721c24;" th:text="${request.rejectReason}"></span></div>
                    </div>
                </div>

                <!-- Financials -->
                <div class="form-section">
                    <h3>Financial Summary</h3>
                    <div class="form-grid">
                        <div><strong>Net Amount:</strong> <span th:text="${#numbers.formatDecimal(request.netAmount, 1, 'COMMA', 2, 'POINT') + ' ' + request.currencyCode}"></span></div>
                        <div><strong>Gross Amount (Est.):</strong> <span th:text="${#numbers.formatDecimal(request.grossAmount, 1, 'COMMA', 2, 'POINT') + ' ' + request.currencyCode}"></span></div>
                    </div>
                </div>

                <!-- Items Table -->
                <div class="form-section">
                    <h3>Request Items</h3>
                    <table class="content-table">
                        <thead>
                        <tr>
                            <th>Item Name</th>
                            <th>Supplier</th>
                            <th>Quantity</th>
                            <th>Unit</th>
                            <th>Unit Price</th>
                            <th>Total Price</th>
                            <th>Description</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="item : ${request.items}">
                            <td th:text="${item.itemName}"></td>
                            <td th:text="${item.supplier.supplierName}"></td>
                            <td th:text="${item.quantity}"></td>
                            <td th:text="${item.unit.unitName}"></td>
                            <td th:text="${#numbers.formatDecimal(item.unitPrice, 1, 'COMMA', 2, 'POINT')}"></td>
                            <td th:text="${#numbers.formatDecimal(item.totalPrice, 1, 'COMMA', 2, 'POINT')}"></td>
                            <td th:text="${item.description}"></td>
                        </tr>
                        </tbody>
                    </table>
                </div>

                <div class="form-section">
                    <h3>Attached Files</h3>
                    <ul>
                        <li th:each="file : ${request.files}">
                            <a th:href="@{/requests/files/{id}/download(id=${file.fileId})}"
                               th:text="${#strings.substring(file.filePath, file.filePath.lastIndexOf('/') + 1)}"></a>
                        </li>
                    </ul>
                </div>
                <div class="form-actions">
                    <a th:href="@{/dashboard}" class="btn btn-secondary" style="background-color: #6c757d; color: white;">Back to Dashboard</a>
                </div>
            </div>
        </div>
    </main>
</div>
<script th:src="@{/js/notifications.js}"></script>
</body>
</html>